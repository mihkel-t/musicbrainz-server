#!/bin/bash

unset SSH_AUTH_SOCK

set -u

DESTINATION="$1"

MB_SERVER_ROOT=$(cd "$(dirname "${BASH_RSYNC_SOLRCLOUD_BACKUPS_DIR[0]}")/../" && pwd)
cd "$MB_SERVER_ROOT"

source admin/config.sh
source admin/functions.sh

RSYNC_SOLRCLOUD_BACKUPS_DIR="$(perl -Ilib -e 'use DBDefs; print DBDefs->SOLR_CLOUD_BACKUP_LOCATION;')"
RSYNC_SOLRCLOUD_BACKUPS_HOST="$(perl -Ilib -e 'use DBDefs; print DBDefs->SOLR_CLOUD_LEADER;')"

if [ -n "$RSYNC_SOLRCLOUD_BACKUPS_HOST" ]; then
    RSYNC_SOLRCLOUD_BACKUPS_PORT=${RSYNC_SOLRCLOUD_BACKUPS_PORT:-22}

    retry rsync \
        --archive \
        --delete \
        --exclude="zk_config/" \
        --rsh "ssh -i $RSYNC_SOLRCLOUD_BACKUPS_KEY -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p $RSYNC_SOLRCLOUD_BACKUPS_PORT" \
        --verbose \
        "solr@$RSYNC_SOLRCLOUD_BACKUPS_HOST:$RSYNC_SOLRCLOUD_BACKUPS_DIR/" \
        "$DESTINATION/"

    make_temp()

    retry rsync \
        --archive \
        --delete \
        --rsh "ssh -i $RSYNC_SOLRCLOUD_BACKUPS_KEY -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p $RSYNC_SOLRCLOUD_BACKUPS_PORT" \
        --verbose \
        "$TEMP_DIR/" \
        "solr@$RSYNC_SOLRCLOUD_BACKUPS_HOST:$RSYNC_SOLRCLOUD_BACKUPS_DIR/"

    rmdir "$TEMP_DIR"
fi

# eof rsync-solrcloud-backups
